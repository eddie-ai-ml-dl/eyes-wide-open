We‚Äôre continuing work on a **People Counting and Direction Detection** system.
Pick up from the current state below and implement the next task: **Refine ‚ÄúINSIDE‚Äù Region Definition**.

---

### üéØ Goal

Detect and count people entering or exiting an area by analyzing trajectories relative to a user-defined curve across an entrance.
The system adapts to various camera angles, auto-detects orientation, saves configuration and diagnostics, and reports IN/OUT counts.

---

### üß© Current State

* **`main.py`** ‚Äî runs YOLO detection/tracking, handles curve loading/creation via `CurveManager`, collects sample anchors, auto-determines orientation, and counts IN/OUT crossings.
* **`modules/curve_manager.py`** ‚Äî handles:

  * interactive curve creation (`click=add`, `right-click/u=undo`, `s`/double-click=save)
  * config I/O (`curve_config.json`)
  * `determine_orientation(sample_anchors)` ‚Üí calls `auto_orient_curve()` and persists results
  * `build_inside_region()` currently uses crude vertical/horizontal extensions.
* **`modules/orientation.py`** ‚Äî defines `auto_orient_curve(curve_np, sample_points, eps, min_crossings)` returning `(orientation:int, diagnostics:dict)`.
* **`modules/tracker_logic.py`** ‚Äî provides `signed_distance_to_curve()` and `update_track_state()`.
* **`utils/viz_tools.py`** ‚Äî has `plot_trajectory()`.
* **`config/curve_config.json`** example:

  ```json
  {
    "curve_points": [[722,390],[721,421],[674,438],[555,418],[459,387],[461,366]],
    "IN_direction": "toward_cam",
    "orientation": 1,
    "camera_orientation": "front-facing",
    "orientation_diagnostics": {"num_samples":16,"confidence":0.76}
  }
  ```

‚úÖ Works: curve creation, auto-orientation, persistence, counting.
‚ö†Ô∏è Problem: `build_inside_region()` fails for `"auto"` and only supports axis-aligned offsets.

---

### üöÄ Next Task ‚Äî **Refine ‚ÄúINSIDE‚Äù Region Definition**

Redesign `build_inside_region()` (and supporting logic) to use **geometry-based, orientation-aware regions**.

#### Functional Requirements

1. **Normal-offset polygon**

   * Compute tangents + normals along the curve.
   * Offset curve points by a configurable distance (e.g., 50 px) along averaged normal.
   * Use `orientation` (¬±1) to choose IN-side.
   * Construct polygon by joining curve + reversed offset.

2. **Persistence**

   * Save `"inside_region"`, `"region_depth"`, `"region_method": "normal_offset"`, and `"region_diagnostics"` into `curve_config.json`.
   * Round all numeric values (including diagnostics) to **2 decimals**.

3. **Fallback**

   * If `IN_direction == "auto"` (orientation unresolved), build a **neutral symmetric** region (offset both sides) so the app doesn‚Äôt crash.
   * Once orientation is known, recompute and persist.

4. **Visualization**

   * Add `CurveManager.visualize_region(frame, color=(0,200,0), alpha=0.2)` to overlay the region (filled or outlined) and optional small direction arrows.

5. **Integration**

   * `main.py`:

     * If `inside_region` exists, load it.
     * Else compute once with known orientation.
     * If unresolved, use neutral fallback.
   * Log whether region was loaded or computed.

6. **Diagnostics**

   * Example:

     ```json
     "region_diagnostics": {
       "method": "normal_offset",
       "region_depth": 50.0,
       "num_points": 12,
       "status": "ok"
     }
     ```

---

### ‚úÖ Deliverables

1. Updated `build_inside_region()` (and helpers if needed).
2. Optional `save_inside_region()` + `visualize_region()`.
3. Minor `main.py` patch to handle fallback and persistence.
4. Small test/demo script to verify:

   * Inside polygon creation and visualization.
   * Stability with ‚Äúauto‚Äù IN_direction.
   * Correct persistence (rounded values).

---

### üß† Constraints

* Preserve backward compatibility with existing configs.
* Keep geometry self-contained in `CurveManager` (or a helper module).
* No style or color hardcoding unless necessary.
* All floats saved with 2 decimal precision.

---

**Start by implementing the geometry-based `build_inside_region()` and persistence according to this prompt.**
Ask for specific file contents (e.g. `curve_manager.py`) if needed.
